# début du "boot" version "22"
version = ('boot.py', 22)

import os

# ================================================
# GARDE ANTI-DOUBLE EXÉCUTION
# ================================================
try:
    __BOOT_DONE
    print("boot.py déjà exécuté → ignoré")
    raise SystemExit
except NameError:
    __BOOT_DONE = True

# ================================================
# DÉTECTION AUTOMATIQUE DU DOSSIER – UNIQUE SOURCE DE VÉRITÉ
# ================================================
if 'lib1' in os.listdir():
    MON_DOSSIER = "lib1/"
    print("Environnement matériel détecté → modules dans /lib1/")
else:
    MON_DOSSIER = ""
    print("Environnement Wokwi détecté → modules à la racine")

# Export global
globals()['MON_DOSSIER'] = MON_DOSSIER

print("\n" + "="*72)
print(" FORTH ESP32-S3 – INITIALISATION (boot.py v22)")
print(f" Dossier modules → '{MON_DOSSIER or 'racine'}'")
print("="*72)

modules = [
    'constantes.json', 'main.py',
    'memoire.py', 'piles.py', 'dictionnaire.py',
    'core_primitives.py', 'core_system.py', 'core_system1.py',
    'words_level1.py', 'tests.py'
]

for nom in modules:
    chemin = MON_DOSSIER + nom if MON_DOSSIER else nom
    try:
        with open(chemin, 'r') as f:
            for ligne in f:
                if 'version' in ligne and '=' in ligne:
                    partie = ligne.split('=', 1)[1].strip()
                    if partie.startswith('('):
                        fichier, num = eval(partie)
                        src = "lib1" if MON_DOSSIER else "racine"
                        print(f"  {fichier:25} → v{num:<6} [{src}]")
                    else:
                        print(f"  {nom:25} → présent")
                    break
            else:
                print(f"  {nom:25} → présent")
    except OSError:
        print(f"  {nom:25} → [introuvable]")

print("="*72)
print("boot.py v22 terminé – exécuté une seule fois")
print("Lancement de main.py...\n")

# fin du "boot" version "22"