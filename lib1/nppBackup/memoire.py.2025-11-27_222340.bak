# début du "memoire" version "11"
class Memoire:
    def __init__(self):
        self.ram = bytearray(512 * 1024)  # 512 KB total
        self.here = 256                    # Dictionnaire démarre à 256 (après zone réservée)
        self.latest = 0                    # Chaîne des définitions
        self.state = 0                     # 0 = interprétation, 1 = compilation
        self.ip = 0                        # Instruction pointer (pointeur d'exécution)
        self.sp = 131072                   # Stack pointer (data stack, haute adresse)
        self.SP0 = self.sp                 # Sauvegarde pour reset
        self.rp = 196608                   # Return stack pointer (même logique)
        self.RP0 = self.rp

    def wpoke(self, addr, val):
        """Écrire 4 bytes (word) à l'adresse addr en little-endian"""
        if addr + 3 >= len(self.ram):
            raise MemoryError(f"wpoke overflow @ {addr} (0x{addr:x}), ram size = {len(self.ram)}")
        self.ram[addr:addr+4] = val.to_bytes(4, 'little')

    def wpeek(self, addr):
        """Lire 4 bytes (word) à l'adresse addr en little-endian"""
        if addr + 3 >= len(self.ram):
            raise MemoryError(f"wpeek overflow @ {addr} (0x{addr:x})")
        return int.from_bytes(self.ram[addr:addr+4], 'little')

    def cpoke(self, addr, val):
        """Écrire 1 byte à l'adresse addr"""
        if addr >= len(self.ram):
            raise MemoryError(f"cpoke overflow @ {addr} (0x{addr:x})")
        self.ram[addr] = val & 0xFF

    def cpeek(self, addr):
        """Lire 1 byte à l'adresse addr"""
        if addr >= len(self.ram):
            raise MemoryError(f"cpeek overflow @ {addr} (0x{addr:x})")
        return self.ram[addr]

    def reset_memory(self):
        """Réinitialiser la mémoire (sans détruire la RAM)"""
        self.here = 256
        self.latest = 0
        self.state = 0
        self.ip = 0
        self.sp = self.SP0
        self.rp = self.RP0

# Instance unique globale
mem = Memoire()

version = ('memoire.py', 11)
print(f"memoire.py v{version[1]} – adressage relatif 0-basé, {len(mem.ram)} bytes disponibles")
# fin du "memoire" version "11"