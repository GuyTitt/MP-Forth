# début du "boot" version "21"
version = ('boot.py', 21)

import os

# ================================================
# GARDE ANTI-DOUBLE EXÉCUTION (critique)
# ================================================
try:
    __BOOT_DEJA_EXECUTE
    print("boot.py déjà exécuté → sortie immédiate")
except NameError:
    __BOOT_DEJA_EXECUTE = True

    # ================================================
    # DÉTECTION AUTOMATIQUE DU DOSSIER
    # ================================================
    try:
        os.mkdir('lib1')
        os.rmdir('lib1')
        MON_DOSSIER = ""
        print("Environnement Wokwi détecté → modules à la racine")
    except OSError:
        MON_DOSSIER = "lib1/"
        print("Environnement matériel détecté → modules dans /lib1/")

    # Export global
    globals()['MON_DOSSIER'] = MON_DOSSIER

    print("\n" + "="*72)
    print(" FORTH ESP32-S3 – INITIALISATION SYSTÈME (boot.py v21)")
    print(f" Dossier modules → '{MON_DOSSIER or 'racine'}'")
    print("="*72)

    modules = [
        'constantes.json', 'main.py',
        'memoire.py', 'piles.py', 'dictionnaire.py',
        'core_primitives.py', 'core_system.py', 'core_system1.py',
        'words_level1.py', 'tests.py'
    ]

    for nom in modules:
        chemin = MON_DOSSIER + nom if MON_DOSSIER else nom
        try:
            with open(chemin, 'r') as f:
                version_trouvee = False
                for ligne in f:
                    if 'version' in ligne and '=' in ligne:
                        partie = ligne.split('=', 1)[1].strip()
                        if partie.startswith('('):
                            fichier, num = eval(partie)
                            src = "lib1" if MON_DOSSIER else "racine"
                            print(f"  {fichier:25} → v{num:<6} [{src}]")
                        else:
                            print(f"  {nom:25} → présent")
                        version_trouvee = True
                        break
                if not version_trouvee:
                    print(f"  {nom:25} → présent")
        except OSError:
            print(f"  {nom:25} → [introuvable]")

    print("="*72)
    print("boot.py v21 terminé – exécuté UNE SEULE FOIS")
    print("Lancement de main.py...\n")

# fin du "boot" version "21"